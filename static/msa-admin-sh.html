<link rel="import" href="/msa/msa.html"></link>
<style>
	msa-admin-sh {
		width:100%;
	}
	msa-admin-sh .output {
		margin: 10px;
		padding: 5px;
		min-height: 200px;
		border: 1px solid black;
	}
	msa-admin-sh .output .req {
		color: grey;
		font-style: italic;
	}
	msa-admin-sh .output .stdout {
		white-space: pre-wrap;
	}
	msa-admin-sh .output .stderr {
		white-space: pre-wrap;
    color: red;
	}
</style>
<template id="msa-admin-sh">
	<table style="margin:10px; width:100%"><tr>
		<td><input class="input" type=text style="width:100%"></td>
		<td><input class="send" type=button value="Send"></td>
		<td><input class="clear" type=button value="Clear"></td>
	</tr></table>
	<div class="output"></div>
</template>
<script>
(function() {

	// methods
	var shMethods = {}
	shMethods.send = function() {
		var input = this.Q('.input'), output = this.Q('.output')
		var cmd = input.value
		var reqStr = "<div class='req'>> "+cmd+"</div>"
		Msa.post("/admin/sh",
			{body:{ cmd:cmd }},
			function(res) {
				var stdoutStr = res.stdout ? "<xmp class='stdout'>"+res.stdout+"</xmp>" : ""
				var stderrStr = res.stderr ? "<xmp class='stderr'>"+res.stderr+"</xmp>" : ""
				output.innerHTML = reqStr + stdoutStr + stderrStr + output.innerHTML
			}
		)
		input.value = ""
		// fill cache
		if(cmd !== this.cmdCache[0]) this.cmdCache.unshift(cmd)
		this.cmdCacheIte = -1
	}
	shMethods.clear = function() {
		this.Q('.output').innerHTML = ""
	}
	shMethods.getNextCmdFromCache = function() {
		if(this.cmdCacheIte < this.cmdCache.length-1) {
			this.cmdCacheIte += 1
			this.Q('.input').value = this.cmdCache[this.cmdCacheIte]
		}
	}
	shMethods.getPrevCmdFromCache = function() {
		if(this.cmdCacheIte > 0) {
			this.cmdCacheIte -= 1
			this.Q('.input').value = this.cmdCache[this.cmdCacheIte]
		}
	}

	// actions
	var shActions = []
	shActions.push({el:".send", evt:"click", act:function() {
		this.send()
	}})
	shActions.push({el:".clear", evt:"click", act:function() {
		this.clear()
	}})
	shActions.push({el:".input", evt:"keydown", act:function(evt) {
		// arrow up & down: cmd cache
		if(evt.key==="ArrowUp") this.getNextCmdFromCache()
		if(evt.key==="ArrowDown") this.getPrevCmdFromCache()
		// enter: send
		if(evt.key==="Enter") this.send()
	}})

	// register element
	Msa.registerElement("msa-admin-sh", {
		template:"#msa-admin-sh",
		oncreate: function() {
			this.cmdCache = []
			this.cmdCacheIte = -1
			this.Q = Msa.Q
			Object.assign(this, shMethods)
			Msa.addActions(this, shActions)
		}
	})
})()
</script>
